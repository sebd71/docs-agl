<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="format-detection" content="telephone=no">
    <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width" />
    <meta name="description" content=" ">

    <title>
	    AGL Developer Site - 
        
            
                2 4 Creating hybrid app  -
            
        
    </title>

    <link rel="SHORTCUT ICON" href="/favicon.ico"/>

    

    
    

    <link rel="canonical" href="http://docs.automotivelinux.org/docs/devguides/en/dev/reference/sdk-devkit/docs/part-2/2_4-Creating-hybrid-app.html">

    <!-- CSS -->
    <link rel="stylesheet" type="text/css" href="/static/styles/main.css">
    <link rel="stylesheet" type="text/css" href="/static/styles/syntax.css">
    <!-- Algolia Search CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.css" />

    <!-- Fonts -->
    <!-- For attribution information, see www/attributions.html -->
    <link href='https://fonts.googleapis.com/css?family=Raleway:700,400,300,700italic,400italic,300italic' rel='stylesheet' type='text/css'>

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
        <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- <script defer type="text/javascript">
        var disqus_developer = ; // this would set it to developer mode
    </script>-->

    <!-- JS -->
    <script defer type="text/javascript" src="/static/js/lib/jquery-2.1.1.min.js"></script>
    <script defer type="text/javascript" src="/static/js/lib/bootstrap.min.js"></script>
<!--    <script defer type="text/javascript" src="/static/js/lib/ZeroClipboard.js"></script>-->

    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', '{}', 'auto');
    ga('send', 'pageview');
</script>

</head>

<body>
    <header>
    <a class="scroll-point pt-top" name="top"></a>
    <nav class="navbar navbar-inverse navbar-fixed-top">
        <div class="container-fluid">
            <div class="navbar-header">
                <a class="navbar-brand" href="/"><img id="logo_top" src="/static/img/branding/agl_title_793x211.png"/></a>
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
            </div>
            <div id="navbar" class="navbar-collapse collapse">
                <div class="nav_bar_left">
                    <ul class="nav navbar-nav">
                        <li >
                            <a href="/docs/getting_started/en/dev/">Getting Started</a>
                        </li>
                                                
                        <li >
                            <a href="/docs/architecture/en/dev/">Architecture Guides</a>
                        </li>

                        <li >
                            <a href="/docs/hardware/en/dev/">Hardware Support</a>
                        </li>

                        <li >
                            <a href="/docs/devguides/en/dev/">Developer Guides</a>
                        </li>
                        
                        <li >
                            <a href="/docs/apis_services/en/dev/">APIs & Services</a>
                        </li>
					</ul>
				</div>
                <div class="nav_bar_right">
                    <ul class="nav navbar-nav">
                        <li >
                            <a href="/techpost" id="blog_button">TechPost<span class="badge" id="new_blog_count"></span></a>
                        </li>
                        <li >
                            <a href="/contribute">Contribute</a>
                        </li>
                        <li>
                            <form class="navbar-form navbar-right" id="header-search-form" role="search">
                                <div class="input-group">
                                    
                                    <input id="header-search-field" type="text" placeholder="Search 'dev' docs..." class="form-control hidden-xs" autocomplete="off">
                                </div>
                            </form>
                        </li>
                    </ul>
                </div>
            </div><!--/.navbar-collapse -->
        </div>
    </nav>
    <div id="_fixed_navbar_spacer" style="padding-top:50px"></div>
</header>














<div class="docs container">

    <!-- Table of Contents -->
    <div class="hidden-xs hidden-sm col-md-4 col-lg-3 site-toc-container">
        <ul class="site-toc">
    

    <li>
        
            <span class="toc-section-heading">
                Yocto layers
            </span>
        

        
        

        
        <ul class="site-toc">
    

    <li>
        
            <a class="" href="/docs/devguides/en/dev/reference/AGL.html">
                AGL Overview
            </a>
            
        

        
        

        
    </li>
    

    <li>
        
            <a class="" href="/docs/devguides/en/dev/reference/meta-agl.html">
                meta-agl
            </a>
            
        

        
        

        
    </li>
    

    <li>
        
            <a class="" href="/docs/devguides/en/dev/reference/meta-agl-demo.html">
                meta-agl-demo
            </a>
            
        

        
        

        
    </li>
    

    <li>
        
            <a class="" href="/docs/devguides/en/dev/reference/meta-agl-devel.html">
                meta-agl-devel
            </a>
            
        

        
        

        
    </li>
    
</ul>

        
    </li>
    

    <li>
        
            <span class="toc-section-heading">
                Development Kit: build AGL image
            </span>
        

        
        

        
        <ul class="site-toc">
    

    <li>
        
            <a class="" href="/docs/devguides/en/dev/reference/sdk-devkit/docs/part-1/1_0_Abstract.html">
                Abstract
            </a>
            
        

        
        

        
    </li>
    

    <li>
        
            <a class="" href="/docs/devguides/en/dev/reference/sdk-devkit/docs/part-1/1_1-Deploy_image.html">
                Deploy image
            </a>
            
        

        
        

        
    </li>
    

    <li>
        
            <a class="" href="/docs/devguides/en/dev/reference/sdk-devkit/docs/part-1/1_2-Setting-up-your_os.html">
                Setting up your operating system
            </a>
            
        

        
        

        
    </li>
    

    <li>
        
            <a class="" href="/docs/devguides/en/dev/reference/sdk-devkit/docs/part-1/1_3-Install-agl-for-porter.html">
                Install Docker image
            </a>
            
        

        
        

        
    </li>
    

    <li>
        
            <a class="" href="/docs/devguides/en/dev/reference/sdk-devkit/docs/part-1/1_4-Inside-the-container.html">
                Inside the container
            </a>
            
        

        
        

        
    </li>
    

    <li>
        
            <a class="" href="/docs/devguides/en/dev/reference/sdk-devkit/docs/part-1/1_5-Build-image-Porter.html">
                Build image for Porter
            </a>
            
        

        
        

        
    </li>
    

    <li>
        
            <a class="" href="/docs/devguides/en/dev/reference/sdk-devkit/docs/part-1/1_6-Porter-image-deployment.html">
                Porter image deployment
            </a>
            
        

        
        

        
    </li>
    

    <li>
        
            <a class="" href="/docs/devguides/en/dev/reference/sdk-devkit/docs/part-1/1_7-SDK-compilation-installation.html">
                SDK compilation and installation
            </a>
            
        

        
        

        
    </li>
    
</ul>

        
    </li>
    

    <li>
        
            <span class="toc-section-heading">
                Development Kit: build AGL application
            </span>
        

        
        

        
        <ul class="site-toc">
    

    <li>
        
            <a class="" href="/docs/devguides/en/dev/reference/sdk-devkit/docs/part-2/2_0_Abstract.html">
                Abstract
            </a>
            
        

        
        

        
    </li>
    

    <li>
        
            <a class="" href="/docs/devguides/en/dev/reference/sdk-devkit/docs/part-2/2_1-Init-sdk-env.html">
                Initialize SDK environment
            </a>
            
        

        
        

        
    </li>
    

    <li>
        
            <a class="" href="/docs/devguides/en/dev/reference/sdk-devkit/docs/part-2/2_2-Trying-out-templates.html">
                Trying out templates
            </a>
            
        

        
        

        
    </li>
    

    <li>
        
            <a class="" href="/docs/devguides/en/dev/reference/sdk-devkit/docs/part-2/2_3-Dev-with-container.html">
                Developing with container
            </a>
            
        

        
        

        
    </li>
    

    <li>
        
            <a class="this-page" href="/docs/devguides/en/dev/reference/sdk-devkit/docs/part-2/2_4-Creating-hybrid-app.html">
                Creating an hybrid app
            </a>
            
                <span class="entry-highlight"></span>
            
        

        
        <div id="page-toc" class="page-toc"></div>

        
    </li>
    
</ul>

        
    </li>
    

    <li>
        
            <span class="toc-section-heading">
                Guides
            </span>
        

        
        

        
        <ul class="site-toc">
    

    <li>
        
            <a class="" href="/docs/devguides/en/dev/reference/iotbzh2016/appfw/03-AGL-AppFW-Privileges-Management.pdf">
                AppFW - Privileges Management
            </a>
            
        

        
        

        
    </li>
    
</ul>

        
    </li>
    
</ul>

    </div>

    <!-- Page content -->
    <div class="col-md-8 col-md-offset-4 col-lg-9 col-lg-offset-3 page-content-container container">
        <div class="page-content row">
            <div class="col-md-offset-1 col-md-10">
                <div class="content-header">

                    <!-- ToC Dropdown (for XS and SM sizes only) -->
                    <div class="toc-dropdown dropdown visible-xs-block visible-sm-block">
                        <button class="btn btn-default dropdown-toggle" type="button" id="tocDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                            Table of Contents
                            <span class="caret"></span>
                        </button>
                        <ul class="dropdown-menu">
                            






<li>
    <a class="" href="reference/AGL.html">
        AGL Overview
    </a>
</li>




<li>
    <a class="" href="reference/meta-agl.html">
        meta-agl
    </a>
</li>




<li>
    <a class="" href="reference/meta-agl-demo.html">
        meta-agl-demo
    </a>
</li>




<li>
    <a class="" href="reference/meta-agl-devel.html">
        meta-agl-devel
    </a>
</li>











<li>
    <a class="" href="reference/sdk-devkit/docs/part-1/1_0_Abstract.html">
        Abstract
    </a>
</li>




<li>
    <a class="" href="reference/sdk-devkit/docs/part-1/1_1-Deploy_image.html">
        Deploy image
    </a>
</li>




<li>
    <a class="" href="reference/sdk-devkit/docs/part-1/1_2-Setting-up-your_os.html">
        Setting up your operating system
    </a>
</li>




<li>
    <a class="" href="reference/sdk-devkit/docs/part-1/1_3-Install-agl-for-porter.html">
        Install Docker image
    </a>
</li>




<li>
    <a class="" href="reference/sdk-devkit/docs/part-1/1_4-Inside-the-container.html">
        Inside the container
    </a>
</li>




<li>
    <a class="" href="reference/sdk-devkit/docs/part-1/1_5-Build-image-Porter.html">
        Build image for Porter
    </a>
</li>




<li>
    <a class="" href="reference/sdk-devkit/docs/part-1/1_6-Porter-image-deployment.html">
        Porter image deployment
    </a>
</li>




<li>
    <a class="" href="reference/sdk-devkit/docs/part-1/1_7-SDK-compilation-installation.html">
        SDK compilation and installation
    </a>
</li>











<li>
    <a class="" href="reference/sdk-devkit/docs/part-2/2_0_Abstract.html">
        Abstract
    </a>
</li>




<li>
    <a class="" href="reference/sdk-devkit/docs/part-2/2_1-Init-sdk-env.html">
        Initialize SDK environment
    </a>
</li>




<li>
    <a class="" href="reference/sdk-devkit/docs/part-2/2_2-Trying-out-templates.html">
        Trying out templates
    </a>
</li>




<li>
    <a class="" href="reference/sdk-devkit/docs/part-2/2_3-Dev-with-container.html">
        Developing with container
    </a>
</li>




<li>
    <a class="this-page" href="reference/sdk-devkit/docs/part-2/2_4-Creating-hybrid-app.html">
        Creating an hybrid app
    </a>
</li>











<li>
    <a class="" href="reference/iotbzh2016/appfw/03-AGL-AppFW-Privileges-Management.pdf">
        AppFW - Privileges Management
    </a>
</li>







                        </ul>
                    </div>

                    
                    
                        <a class="edit" href=""><span class="glyphicon glyphicon-pencil" aria-hidden="true"></span> Edit</a>

                    
                    

                    <!-- Language dropdown -->
                    <div class="dropdown">
                        <button class="btn btn-default dropdown-toggle" type="button" id="languageDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                            
                            <span class="caret"></span>
                        </button>

                        <!-- List all languages -->
                        <ul class="dropdown-menu" aria-labelledby="languageDropdown">
                            
                        </ul>
                    </div>

                    <!-- Version dropdown -->
                    <div class="dropdown">
                        <button class="btn btn-default dropdown-toggle" type="button" id="versionDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                            dev
                            
                            <span class="caret"></span>
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="versionDropdown">

                            <!-- List versions available in this language -->
                            
                        </ul>
                    </div>
                </div>

                
                
                

                
                

                <!-- Show warnings for special versions -->
                <!-- dev warning -->
                
                    <div class="alert docs-alert alert-info" role="alert">
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                        Draft version of documentation under development may change!
                        <a href="/docs/en/latest/">
                            Click here for the latest released version.
                        </a>
                    </div>
                
                
                <!-- outdated warning -->
                


                <div id="page-toc-source">
                    <!-- WARNING: This file is generated by fetch_docs.js using /w/workspace/sandbox-doc-update/webdocs-agl/content/tocs/devguides/fetched_files.yml -->

<h1 id="creating-your-own-hybrid-application">Creating your own hybrid application</h1>

<p>In this section, we describe how to extend the provided templates to
create a real application that provides information about CPUs:
- obtain target CPU count;
- obtain target CPU load, by processor;
- display results with a graphical interface.</p>

<p>This will consist in 4 main steps:
- get a minimal template, with a default Service;
- extend the Service to add API verbs (<code class="highlighter-rouge">cpucount</code>, <code class="highlighter-rouge">cpuload</code>);
- add a Qt/QML Application to use and display these verbs results;
- package the new Service/Application couple as a <strong>Hybrid Application</strong>.</p>

<p>In this section, we get the detailed steps to modify the templates but
the result is also available directly in app-framework-templates/demos.</p>

<h3 id="get-the-default-hybrid-application-template">Get the default Hybrid application template</h3>

<p>Log into the DevKit container, clone the app-framework-templates
repository (if not already done) and copy the default Hybrid Application
template in the home directory:
<code class="highlighter-rouge">
$ cd $HOME
$ git clone https://github.com/iotbzh/app-framework-templates
$ cp -a app-framework-templates/templates/hybrid-qml ~/cpu-hybrid-qml
$ cd ~/cpu-hybrid-qml
</code></p>

<h3 id="rename-application-add-api-verbs-to-service">Rename application, add API verbs to Service</h3>

<p>First, rename <code class="highlighter-rouge">xxxxxx-hybrid-binding.c</code> to <code class="highlighter-rouge">cpu-hybrid-qml-binding.c</code>
<code class="highlighter-rouge">
$ mv xxxxxx-hybrid-qml-binding.c cpu-hybrid-qml-binding.c
</code>
Then in <code class="highlighter-rouge">cpu-hybrid-qml-binding.c</code>, line 42, replace <code class="highlighter-rouge">xxxxxx</code> by <code class="highlighter-rouge">cpu</code>:
<code class="highlighter-rouge">
.v1 = {
    .info = "cpu hybrid service",
    .prefix = "cpu",
    .verbs = verbs
}
</code>
In <code class="highlighter-rouge">CMakeLists.txt</code>, line 20, change project name to <code class="highlighter-rouge">cpu-hybrid-qml</code>.
```
###########################################################################
project(cpu-hybrid-qml)</p>

<p>cmake_minimum_required(VERSION 3.3)
```</p>

<p>Then, in your text editor, open <code class="highlighter-rouge">cpu-hybrid-binding.c</code> and do the
following modifications:</p>

<h4 id="cpucount-verb">‘cpucount’ verb</h4>

<p>At line 18, add required header files:
<code class="highlighter-rouge">
#define GNU_SOURCE
#include &lt;stdio.h&gt;
#include &lt;unistd.h&gt;
#include &lt;json-c/json.h&gt;
</code></p>

<p>At line 32, add new API verb “CPUCount” function:
```
}</p>

<p>static void CPUCount (struct afb_req request)
{
    long count = sysconf(_SC_NPROCESSORS_ONLN);
    char count_str[8];
    snprintf (count_str, 8, “%ld”, count);
    afb_req_success(request, NULL, count_str);
}</p>

<p>// NOTE: this sample does not use session to keep test a basic as possible
```</p>

<p>At line 47, define new API verb “count”:
<code class="highlighter-rouge"><span class="w">
 </span><span class="p">{</span><span class="nt">"ping"</span><span class="err">,</span><span class="w"> </span><span class="err">AFB_SESSION_NONE,</span><span class="w"> </span><span class="err">ping</span><span class="w"> </span><span class="err">,</span><span class="w"> </span><span class="nt">"Ping the binder"</span><span class="err">},</span><span class="w">
 </span><span class="p">{</span><span class="nt">"count"</span><span class="err">,</span><span class="w"> </span><span class="err">AFB_SESSION_NONE,</span><span class="w"> </span><span class="err">CPUCount</span><span class="w"> </span><span class="err">,</span><span class="w"> </span><span class="nt">"returns number of CPUs on target board"</span><span class="err">},</span><span class="w">
 </span><span class="p">{</span><span class="err">NULL</span><span class="p">}</span><span class="w">
</span></code></p>

<p>The <code class="highlighter-rouge">CPUCount()</code> C function uses standard Linux calls to retrieve the
CPU count in a numeric (long) variable, then converts it to a string and
returns it as an argument of the default Binder success function
(<code class="highlighter-rouge">afb_req_success(...)</code>).</p>

<p>The function is then associated to the “count” API verb.</p>

<h4 id="cpuload-verb">‘cpuload’ verb</h4>

<p>At line 24, add systemd and <code class="highlighter-rouge">&lt;time.h&gt;</code> header files, and some definitions:
```
#include &lt;afb/afb-plugin.h&gt;
#include <stdlib.h>
#include <string.h>
#include <time.h>
#include &lt;systemd/sd-event.h&gt;
#define MAXCPUS 16
static long cpucount;
static long double loadpast[4][MAXCPUS], loadnow[4][MAXCPUS], load[MAXCPUS];</time.h></string.h></stdlib.h></p>

<p>const struct AFB_interface *interface;
```</p>

<p>At line 50, add following helper and API functions:
```
}</p>

<p>static char* LookupStringInFile (char *string, char *filename)
{
	FILE *file;
	char *line;</p>

<div class="highlighter-rouge"><pre class="highlight"><code>file = fopen (filename, "r");
line = malloc (256);
/* lookup string on file line, stop there if found */
while (fgets (line, 256, file)) {
	if (strstr (line, string))
		break;
}
fclose(file);

return line; }
</code></pre>
</div>

<p>static int MeasureCPULoad (sd_event_source *src, uint64_t now, void *data)
{
	sd_event *loop = (sd_event *)data;
	char cpuname[6] = “cpu”;
	char num_str[2];
	int num, i;
	char *line;</p>

<div class="highlighter-rouge"><pre class="highlight"><code>/* iterate on each CPU */
for (num = 0; num &lt; cpucount; num++) {
	/* construct lookup string ("cpu1" e.g.) */
	snprintf (num_str, 2, "%d", num);
	strncat (cpuname, num_str, 2);

	/* lookup string in file, get current load values */
	line = LookupStringInFile(cpuname, "/proc/stat");
	sscanf (line, "%*s %Lf %Lf %Lf %Lf", &amp;loadnow[0][num], \
		  &amp;loadnow[1][num], &amp;loadnow[2][num], &amp;loadnow[3][num]);
	free (line);

	/* calculate average load by comparing with previous load */
	load[num] = ((loadnow[0][num]+loadnow[1][num]+loadnow[2][num])
	  - (loadpast[0][num]+loadpast[1][num]+loadpast[2][num])) /
	((loadnow[0][num]+loadnow[1][num]+loadnow[2][num]+loadnow[3][num])
	  - (loadpast[0][num]+loadpast[1][num]+loadpast[2][num]+ \
      loadpast[3][num]));

	/* store current load values as previous ones */
	for (i = 0; i &lt; 4; i++)
		loadpast[i][num] = loadnow[i][num];
}

/* re-fire the function in 5 seconds ("now" + 5 microseconds) */
sd_event_add_time (loop, &amp;src, CLOCK_MONOTONIC, now+5000000, 0,
				   MeasureCPULoad, loop);

return 1; }
</code></pre>
</div>

<p>static void CPULoad (struct afb_req request)
{
	const char *num_str = afb_req_value (request, “num”);
	int num;
	char load_str[4];</p>

<div class="highlighter-rouge"><pre class="highlight"><code>/* no "num" argument was given : fail */
if (!num_str)
	afb_req_fail (request, "failed", "please provide CPU number as \
						   argument");

/* prevent negative number, or superior to CPU count */
num = atoi (num_str);
if ((num &lt; 0) || (num &gt;= cpucount)) {
	afb_req_fail (request, "failed", "invalid CPU number argument");
	return;
}

/* convert load to readable format and return it */
snprintf (load_str, 4, "%.0Lf%%", load[num]*100);
afb_req_success(request, NULL, load_str); } ```
</code></pre>
</div>

<p>At line 133, define new API verb:
<code class="highlighter-rouge"><span class="w">
 </span><span class="p">{</span><span class="nt">"count"</span><span class="err">,</span><span class="w"> </span><span class="err">AFB_SESSION_NONE,</span><span class="w"> </span><span class="err">CPUCount</span><span class="w"> </span><span class="err">,</span><span class="w"> </span><span class="nt">"returns number of CPUs on target board"</span><span class="err">},</span><span class="w">
 </span><span class="p">{</span><span class="nt">"load"</span><span class="err">,</span><span class="w"> </span><span class="err">AFB_SESSION_NONE,</span><span class="w"> </span><span class="err">CPULoad</span><span class="w"> </span><span class="err">,</span><span class="w"> </span><span class="nt">"returns designated CPU load on target board"</span><span class="err">},</span><span class="w">
 </span><span class="p">{</span><span class="err">NULL</span><span class="p">}</span><span class="w">
</span><span class="err">};</span><span class="w">
</span></code></p>

<p>At line 149, initialize static variables and callbacks in the Service
registration function:
```
const struct AFB_plugin *pluginAfbV1Register (const struct AFB_interface *itf)
{
	interface = itf;
	sd_event *loop;
	sd_event_source *src;
	uint64_t now;
	int i;</p>

<div class="highlighter-rouge"><pre class="highlight"><code>/* get CPU count, limiting it to MAXCPUS (default : 16) */
cpucount = sysconf(_SC_NPROCESSORS_ONLN);
if (cpucount &gt; MAXCPUS)
	cpucount = MAXCPUS;

/* initialize past load to 0 for each CPU */
for (i = 0; i &lt; cpucount; i++)
	loadpast[0][i] = loadpast[1][i] = loadpast[2][i] \
							= loadpast[3][i] = 0;

/* register the CPU load measuring function, fires immediately ("now") */
loop = afb_daemon_get_event_loop (interface-&gt;daemon);
sd_event_now (loop, CLOCK_MONOTONIC, &amp;now);
sd_event_add_time (loop, &amp;src, CLOCK_MONOTONIC, now, 0,
				   MeasureCPULoad, loop);

return &amp;plugin_desc; } ```
</code></pre>
</div>

<p>This example is slightly more complicated, and illustrates more advanced
concepts:
- getting argument strings from the request;
- initializing variables, launching custom functions at startup;
- using the Binder event loop with callbacks.</p>

<p>Some remarks on the code:
- Our new <code class="highlighter-rouge">load</code> verb will require a <code class="highlighter-rouge">num</code> argument matching the CPU
  we want to query (“0” for “CPU0”, “1” for “CPU1”…).</p>

<p>For this, we use the <code class="highlighter-rouge">afb_req_value()</code> helper function to retrieve
  it as a string. If no argument is given, or the argument is invalid
  (-1 or 200 for instance), we use the <code class="highlighter-rouge">afb_req_fail()</code> helper function
  to give an explicit error message.</p>

<ul>
  <li>
    <p>Measuring CPU load effectively consists in comparing 2 load values
(past and current) within a certain time interval.</p>

    <p>For this, we create a recurring <code class="highlighter-rouge">MeasureCPULoad()</code> function which
will re-fire itself every 5 seconds to measure loads and compare it
with the former ones. We use the <code class="highlighter-rouge">sd_event_add_time()</code> function
for this purpose, passing “5000000” for 5 seconds.</p>
  </li>
  <li>
    <p>A recurring function needs to be run at least once at startup.</p>

    <p>For this, we use the mandatory <code class="highlighter-rouge">pluginAfbV1register()</code> function, run
at Binder startup. We initialize CPU count and load variables
(<code class="highlighter-rouge">cpucount</code>, <code class="highlighter-rouge">loadpast[4][...]</code>) and most importantly retrieve
the Binder event loop with <code class="highlighter-rouge">afb_daemon_get_event_loop()</code> to run
our first occurence of <code class="highlighter-rouge">MeasureCPULoad()</code>. It will then run
indefinitely.</p>
  </li>
</ul>

<h3 id="add-a-qtqml-frontend">Add a Qt/QML frontend</h3>

<p>We will now create a QML frontend for our service.</p>

<p>The full source code can be found in
<code class="highlighter-rouge">app-framework-templates/demos/cpu-hybrid-qml/cpu-hybrid-qml-app.qml</code>.</p>

<p>Let’s copy it into our project and remove old qml file:
<code class="highlighter-rouge">
$ cp ~/app-framework-templates/demos/cpu-hybrid-qml/cpu-hybrid-qml-app.qml .
$ rm xxxxxx-hybrid-qml-app.qml
</code></p>

<p>The most important bits are the following, line 9:
<code class="highlighter-rouge">
property string port_str: Qt.application.arguments[1]
property string token_str: Qt.application.arguments[2]
property string address_str: "ws://localhost:"+port_str+"/api?token="+token_str
</code></p>

<p>then later:
<code class="highlighter-rouge">
WebSocket {
url: address_str
[...]
active: true
}
</code></p>

<p>This forges a WebSocket URL string (2 components, port and token, are
predefined and passed by the Application Framework manager) and passes
it as the <code class="highlighter-rouge">url</code> property of our WebSocket widget. The <code class="highlighter-rouge">active</code> property
makes sures the connection gets initialized when the application is
launched.</p>

<p>The following code:
<code class="highlighter-rouge">
Button {
text: "Re-count CPUs"
onClicked: {
	verb_str = “count”
	request_str = '[' + msgid_enu.call + ',"99999","' + api_str+'/'+verb_str + '", null ]'
	websocket.sendTextMessage (request_str)
}
</code></p>

<p>defines a Button widget which, when clicked on, creates a request with
the <code class="highlighter-rouge">cpu</code> API and <code class="highlighter-rouge">load</code> verb, and sends it.</p>

<p>Finally, the following code
<code class="highlighter-rouge">
WebSocket {
[...]
	onTextMessageReceived: {
		var message_json = JSON.parse (message)
		var request_json = message_json[2].request
		if (verb_str == "count")
			count = request_json.info
}
</code></p>

<p>parses the final response as JSON and, if the verb was <code class="highlighter-rouge">count</code>,
retrieves the <code class="highlighter-rouge">info</code> field which contains the answer (1, 2, 3…).</p>

<h3 id="package-our-hybrid-application">Package our Hybrid application</h3>

<p>Run the following commands:
<code class="highlighter-rouge">
$ mkdir build; cd build
$ cmake ..
|snip]
$ make
Scanning dependencies of target cpu-hybrid-qml
[ 33%] Building C object CMakeFiles/cpu-hybrid-qml.dir/cpu-hybrid-qml-binding.c.o
[ 66%] Linking C shared module cpu-hybrid-qml.so
[ 66%] Built target cpu-hybrid-qml
Scanning dependencies of target widget
[100%] Generating cpu-hybrid-qml.wgt
NOTICE: -- PACKING widget cpu-hybrid-qml.wgt from directory package
[100%] Built target widget
</code></p>

<p>The package <code class="highlighter-rouge">cpu-hybrid-qml.wgt</code> is then produced in the build directory
and ready to be installed and run on the target.</p>

<h3 id="install-our-hybrid-application-on-the-target">Install our Hybrid application on the target</h3>

<p>Copy the package to the target board:
<code class="highlighter-rouge">
$ scp cpu-hybrid-qml.wgt root@$BOARDIP:~/
</code></p>

<p>Then open a new session on the target and install the package:
<code class="highlighter-rouge">
$ ssh root@$BOARDIP
$ afm-util install cpu-hybrid-qml.wgt
{ "added": "cpu-hybrid-qml@0.1" }
</code></p>

<p>Next, run the application:
<code class="highlighter-rouge">
$ afm-util start cpu-hybrid-qml@0.1
11
</code></p>

<p>The following UI appears and displays the number of CPUs and the load
for the selected CPU, updated every 5 seconds:</p>

<p><img src="pictures/cpu_hybrid_qml.png" alt="" /></p>

<h3 id="add-a-html5-frontend">Add a HTML5 frontend</h3>

<p>We will now create a HTML5 frontend for our service.</p>

<p>For this, we will re-use the layout of the HTML5 template found in
<code class="highlighter-rouge">app-framework-templates/templates/hybrid-html5</code>.</p>

<p>The most noticeable steps are the following:
- duplicate the template <code class="highlighter-rouge">app-framework/templates/hybrid-html5</code> to a new
  directory <code class="highlighter-rouge">~/cpu-hybrid-html5</code>
- copy <code class="highlighter-rouge">cpu-hybrid-qml-binding.c</code> to
  <code class="highlighter-rouge">~/cpu-hybrid-html5/binding/cpu-hybrid-html5-binding.c</code> and remove
  the previous binding code
- in <code class="highlighter-rouge">CMakeLists.txt</code>, line 20, rename <code class="highlighter-rouge">xxxxxx-hybrid-html5</code> to
  <code class="highlighter-rouge">cpu-hybrid-html5</code>, and line 64, rename <code class="highlighter-rouge">xxxxxx-hybrid-binding.c</code> to
  <code class="highlighter-rouge">cpu-hybrid-html5-binding.c</code>
- in <code class="highlighter-rouge">app/etc/AppDefaults.js</code>, line 24, rename <code class="highlighter-rouge">xxxxxx-hybrid-html5</code> to
  <code class="highlighter-rouge">cpu-hybrid-html5</code>
- in <code class="highlighter-rouge">package.json</code>, line 2, rename <code class="highlighter-rouge">xxxxxx-hybrid-html5</code> to
  <code class="highlighter-rouge">cpu-hybrid-html5</code></p>

<h4 id="cpucount-verb-1">‘cpucount’ verb</h4>

<p>Open <code class="highlighter-rouge">app/Frontend/pages/SampleHome/SampleHome.html</code> and, at line 19,
replace:
```</p>
<submit-button class="session-button " icon="fi-arrows-compress" label="Refresh" clicked="ctrl.RefreshSession"></submit-button>
<div class="highlighter-rouge"><pre class="highlight"><code>
with:
</code></pre>
</div>
<submit-button class="session-button " label="CPU status" clicked="ctrl.CpuCount"></submit-button>
<div class="highlighter-rouge"><pre class="highlight"><code>
Open `app/Frontend/pages/SampleHome/SampleHome.js` and, at line 51, replace:
</code></pre>
</div>
<p>scope.RefreshSession = function() {
    console.log (“RefreshSession”);
    AppCall.get (“xxxxxx”, “ping”, {/<em>query</em>/}, scope.OnResponse, scope.InvalidApiCall);
}
```</p>

<p>with:
<code class="highlighter-rouge">
scope.CpuCount = function() {
    AppCall.get ("cpu", "count", {/*query*/}, scope.OnResponse, scope.InvalidApiCall);
}
</code></p>

<p>then at line 29, replace:
<code class="highlighter-rouge">
case 'PING':
    break;
</code></p>

<p>with:
<code class="highlighter-rouge">
case 'COUNT':
    // Get CPU count from response
    var cpucount = jresp.request.info;
    Notification.success ({message: "CPU count: " + cpucount , delay: 3000});
    break;
</code></p>

<p>We first associate a HTML button with the <code class="highlighter-rouge">CPUCount()</code> function found in
the JavaScript code. Then, in the JavaScript code, we make this function
use the <code class="highlighter-rouge">AppCall.get</code> helper function to fire the <code class="highlighter-rouge">cpu/count</code> request.</p>

<p>The response will then be parsed in the generic <code class="highlighter-rouge">OnResponse()</code> function,
where the verb is converted uppercase (<code class="highlighter-rouge">count</code> -&gt; <code class="highlighter-rouge">COUNT</code>). And then, the
response <code class="highlighter-rouge">info</code> field containing CPU count will be displayed on the
page.</p>

<h4 id="cpuload-verb-1">‘cpuload’ verb</h4>

<p>Open <code class="highlighter-rouge">app/Frontend/pages/SampleHome/SampleHome.js</code> and, at line 33, add:
<code class="highlighter-rouge">
    Notification.success ({message: "CPU count: " + cpucount , delay: 3000});
    // Iterate and fire CPU load request for each CPU
    for (var i = 0; i &lt; cpucount; i++) {
        AppCall.get ("cpu", "load", {num: i}, scope.OnResponse, scope.InvalidApiCall);
    }
    break;
</code></p>

<p>Then at line 39, add:
<code class="highlighter-rouge">
case 'LOAD':
    // Get CPU load from response
    var cpuload = jresp.request.info;
    Notification.success ({message: "CPU load: " + cpuload , delay: 3000});
    break;
</code></p>

<p>Now that we have the CPU count number, we can iterate on it to fire one
<code class="highlighter-rouge">load</code> request per CPU (<code class="highlighter-rouge">cpu/load {num:0}</code>, <code class="highlighter-rouge">cpu/load{num:1}</code> …).</p>

<p>Then, as we did before, we parse the response and display its result on
the page.</p>

<h3 id="package-our-hybrid-html5-application">Package our hybrid HTML5 application</h3>

<p>In <code class="highlighter-rouge">config.xml.in</code>, line 2, replace <code class="highlighter-rouge">xxxxxx-hybrid-html5</code> with <code class="highlighter-rouge">cpu-hybrid-html5</code>.</p>

<p>Then, prepare the directory for gulp processing:
<code class="highlighter-rouge">
$ npm install
[snip]
</code></p>

<p>Then, run the following commands:
<code class="highlighter-rouge">
$ mkdir build; cd build
$ cmake ..
|snip]
$ make
Scanning dependencies of target cpu-hybrid-html5
[ 33%] Building C object CMakeFiles/cpu-hybrid-html5.dir/binding/cpu-hybrid-html5-binding.c.o
[ 66%] Linking C shared module cpu-hybrid-html5.so
[ 66%] Built target cpu-hybrid-html5
Scanning dependencies of target widget
[100%] Generating cpu-hybrid-html5.wgt
[snip]
[100%] Built target widget
</code></p>

<p>A <code class="highlighter-rouge">cpu-hybrid-html5.wgt</code> installable package will be produced in the
current directory.</p>

<h3 id="install-our-hybrid-application-on-the-target-1">Install our Hybrid application on the target</h3>

<p>Copy the package to the target board:
<code class="highlighter-rouge">
$ scp cpu-hybrid-html5.wgt root@$BOARDIP:~/
</code></p>

<p>Then open a new session on the target and install the package:
<code class="highlighter-rouge">
$ ssh root@$BOARDIP
$ afm-util install cpu-hybrid-html5.wgt
{ "added": "cpu-hybrid-html5@0.1" }
</code></p>

<p>Next, run the application:
<code class="highlighter-rouge">
$ afm-util start cpu-hybrid-html5@0.1
12
</code></p>

<p>The following UI appears:</p>

<p><img src="pictures/hybrid_html5_app_on_target.png" alt="" /></p>

<p>Each time the user hits the “CPU” button, CPU count and loads are displayed.</p>



                </div>
            </div>
        </div>
        <div class="row">
            <div class="blue-divider"></div>
<footer>
    <div class="container-fluid">
        <div class="row">
    <div class="col-sm-9">
        <h1>More Resources</h1>
        <div class="row">
            <div class="col-sm-4">
                <h2>General</h2>
                <ul class="nav">
                    <li>
                        <a target="_blank" href="https://www.automotivelinux.org/">AGL Developer Community</a>
                    </li>
                    <li>
                        <a href="https://www.automotivelinux.org/software/download/">Download Distribution</a>
                    </li>
                    <li>
                        <a href="https://gerrit.automotivelinux.org/gerrit/#/admin/projects/">Source Code on Git</a>
                    </li>
                    <li>
                        <a target="_blank" href="/contact">Mailing List</a>
                    </li>
                </ul>
            </div>
            <div class="col-sm-4">
                <h2>Development</h2>
                <ul class="nav">
                    <li><a target="_blank" href="https://wiki.automotivelinux.org/agl-distro/source-code">Source Code</a></li>
                    <li><a target="_blank" href="https://jira.automotivelinux.org/browse/SPEC/?selectedTab=com.atlassian.jira.jira-projects-plugin:summary-panel">Issue Tracker</a></li>
                    <li><a target="_blank" href="https://wiki.automotivelinux.org/">Wiki</a></li>
                    <li><a href="https://www.automotivelinux.org/contact-us">Contact</a></li>
                </ul>
            </div>
            <div class="col-sm-4">
                <h2>Automotive Grade Linux @ Linux Foundation</h2>
                <ul class="nav">
                    <li>
                        <a target="_blank" href="https://www.automotivelinux.org/">About AGL</a>
                    </li>
                    <li>
                        <a target="_blank" href="http://www.linuxfoundation.org/">About Linux Foundation</a>
                    </li>
                    <li>
                        <a target="_blank" href="https://wiki.automotivelinux.org/start/getting-started">Join AGL community</a>
                    </li>
                    <li>
                        <a target="_blank" href="https://www.automotivelinux.org/about/members">Members</a>
                    </li>
                </ul>
            </div>
        </div>
    </div>
    <div class="col-sm-3">
        <h1>Contribute</h1>
        <p style="padding-top:20px"><strong>Help AGL move forward!</strong></p>
        <p>Report bugs, improve the docs, or contribute to the code.</p>
        <a href="/contribute" class="btn btn-lg btn-primary">
            Learn More
        </a>
        <p style="padding-top:20px"> <a href="https://twitter.com/autogradelinux" class="twitter-follow-button" data-show-count="false">Follow @autogradelinux</a></p>
    </div>
</div>
<div class="row">
	<div class="col-sm-9">
		<p class="copyright_text">
			Copyright &copy; 2015-2016 Automotive Grade Linux Documentation, Licensed under the <a target="_blank" href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a>.
			<br/>
			Automotive Grade Linux and logos are <a target="_blank" href="http://www.linuxfoundation.org">trademarks</a> of The Linux Foundation.
			<br/>
			Initial site design from <a href="https://cordova.apache.org/">Cordova website.</a> - warm thanks !
		</p>
	</div>
    <div class="col-sm-3">
		<small class="stats">Page rendered at:  2017-07-04 00:02:41 +0000</small>
		
		<br/><small class="stats"><a href="https://raw.githubusercontent.com/iotbzh/agl-documentation/master/sdk-devkit/docs/part-2/2_4-Creating-hybrid-app.md">Link to source document</small>
		
	</div>
</div>

    </div>
</footer>

        </div>
    </div>
</div>

<script defer type="text/javascript" src="/static/js/lib/toc.min.js"></script>
<script defer type="text/javascript" src="/static/js/docs.js"></script>

    <script defer type="text/javascript" src="/static/js/twitter.js"></script>
    



<script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.js"></script>
<script type="text/javascript">
    docsearch({
        apiKey: 'edd30bcff9f6df4b095c41cba3e5a418',
        indexName: 'automotivelinux',
        inputSelector: '#header-search-field',
    });
</script>

            
    

</body>
</html>
